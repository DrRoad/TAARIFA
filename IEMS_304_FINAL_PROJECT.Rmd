---
title: "IEMS 304 Final Project"
author: "Eric Chang, Chen Lin, Haoyu Wang, Allie Woodhouse"
date: "Tuesday, March 01, 2016"
output: html_document
---

Bagging, boosted tree, random forest


## Data prep and variable selection

Notes:

1. Combined "non functional" and "functional needs repair" response variable.
2. Filtered redundant variables
3. Added `construction year` and `population` missing value dummy

```{r, message=FALSE}
library(dplyr)
library(ggplot2)
library(magrittr)

# Read data
df.labels <- read.csv("train_labels.csv")
df.values  <- read.csv("train_values.csv")

# Create dependent variable, reduce to binomial logistic regression 
df.labels$status_group <- as.character(df.labels$status_group)

df.labels <- df.labels %>%
  mutate(status_group = replace(status_group, status_group=="functional", 1),
         status_group = replace(status_group, status_group=="non functional", 0),
         status_group = replace(status_group, status_group=="functional needs repair", 0))

# Join datasets
train <- left_join(df.values, df.labels, by="id")

train <- select(train, status_group, gps_height,
                   amount_tsh, longitude, latitude,
                   basin, region, 
                   population, public_meeting, 
                   scheme_management, permit, construction_year,
                   extraction_type_class,
                   management_group, payment,
                   water_quality, quantity,
                   source_type, waterpoint_type)

train$status_group <- as.factor(train$status_group) # Convert status_group to factor for regression

# Construction year variable - dealing with missing values
train$construction_year_miss = ifelse(train$construction_year==0, 1, 0)
train$construction_year_miss <- as.factor(train$construction_year_miss)

# Construction year variable - dealing with missing values
train$population_miss = ifelse(train$population==0, 1, 0)
train$population_miss <- as.factor(train$population_miss)
```

\newpage

## Variable Importance

We examine the importance of each variables and try to filter out unnecessary variables to simplify analysis.

```{r, eval=FALSE}
# Random Forest
library(randomForest)
fit  <-  randomForest(as.factor(status_group) ~ ., data=train)
varImpPlot(fit)
```
![Variable Importance Plot](VarImpPlot.png)

We filtered our predictor variables down to 11 based on the variable importance plot.

```{r}
train <- select(train, -management_group, -public_meeting,
                       -permit, -water_quality, -basin, -amount_tsh,
                       -scheme_management, -source_type)
train <- filter(train, longitude > 1)
```

\newpage

## Plots

```{r, eval=FALSE}
# Longitude and Latitude
ggplot(data=train) + 
  geom_point(aes(x=longitude, y=latitude, 
                  color=status_group, alpha=0.5, size=1), size=1) +
  facet_grid(.~status_group)
```
![](LongLat.png)

The clustering of the good pumps as well as the nonlinearity of the clustering among the x and y (longitude and latitude) axes lead us to believe that we should include an interaction and spline in our model.   

For Prof:   
1. This assumption correct?
2. Interaction among splines?

### Looking at Longitude and Latitude Nonlinearity

```{r, message=FALSE}
library(splines); library(pROC);

# Split into 80/20 Train/Test Set
train.glm <- sample_frac(train, .8)
test.glm <- setdiff(train, train.glm)

# Linear vs. Spline terms
lin <- glm(status_group ~ longitude + latitude, data=train.glm, family=binomial)
plot.roc(test.glm$status_group, predict(lin, newdata=test.glm, type="response"))

spl <- glm(status_group ~ bs(longitude) + bs(latitude), data=train.glm, family=binomial)
plot.roc(test.glm$status_group, predict(spl, newdata=test.glm, type="response"))

# INTERACTION TERMS
int1 <- glm(status_group ~ (bs(longitude) + bs(latitude)), 
             data=train.glm, family=binomial)
p <- plot.roc(test.glm$status_group, predict(int1, newdata=test.glm, type="response"))
p$auc

int2 <- glm(status_group ~ (bs(longitude) + bs(latitude))^2, 
             data=train.glm, family=binomial)
p <- plot.roc(test.glm$status_group, predict(int2, newdata=test.glm, type="response"))
p$auc

int3 <- glm(status_group ~ (bs(longitude) + bs(latitude))^3, 
             data=train.glm, family=binomial)
p <- plot.roc(test.glm$status_group, predict(int3, newdata=test.glm, type="response"))
p$auc

int4 <- glm(status_group ~ (bs(longitude) + bs(latitude))^4, 
             data=train.glm, family=binomial)
p <- plot.roc(test.glm$status_group, predict(int4, newdata=test.glm, type="response"))
p$auc
```

## Quantity Variable
```{r, eval=FALSE}
library(ggplot2)
ggplot(data=train) + stat_count(aes(x=status_group, fill=..count..)) + facet_grid(. ~ quantity)
```

\newpage

## Performance Metrics
```{r, eval=FALSE}
# Obtaining True/False table for random forest observations
tab <- table(train$status_group, train$status_group.rf)
prop.table(table(train$status_group, train$status_group.rf), 1)
sum(diag(tab))/sum(tab)
```



